name: Build and Deploy Delphi to Production

on:
  push:
    branches: [ main ]  # Déclenche le workflow sur les pushes vers main

jobs:
  build-and-deploy:
    runs-on: [self-hosted, dev]  # Cible le runner de production

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
          
      - name: Créer le dossier de sortie
        shell: cmd
        run: |
          cd /d "%GITHUB_WORKSPACE%"
          mkdir Output\Release
            
      - name: Compilation en mode Release
        shell: cmd
        run: |
          "C:\Program Files (x86)\Microsoft Visual Studio\18\BuildTools\Common7\Tools\VsDevCmd.bat"
          "C:\Program Files (x86)\Embarcadero\Studio\37.0\bin\rsvars.bat"
          cd /d "%GITHUB_WORKSPACE%"
          "msbuild src\FeedFlow.dproj /t:Build /p:Config=Release /p:Platform=Win64 /p:DCC_OutputDir="%GITHUB_WORKSPACE%\Output\Release" /p:DCC_UsePackageOutputPath=true /m /v:diag /fl /flp:LogFile=msbuild.log"

      - name: Lister les fichiers générés
        shell: cmd
        run: |
          cd /d "%GITHUB_WORKSPACE%"
          dir /s /b Output\Release\